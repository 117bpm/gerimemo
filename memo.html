<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>„Åí„Çä„É°„É¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f6efe9;
}

.app {
  max-width: 520px;
  margin: 0 auto;
  padding: 16px;
  background: #fffaf6;
  min-height: 100vh;
}

h1 {
  text-align: center;
  color: #b33a2b;
  margin-bottom: 16px;
}

input, textarea {
  width: 100%;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid #e0cfc2;
  font-size: 16px;
  background: #fffdfb;
  margin-bottom: 14px;
}

textarea {
  resize: none;
  overflow: hidden;
  min-height: 4.5em;
  line-height: 1.4;
}

/* ===== „Éú„Çø„É≥Ë°å ===== */
.action-row {
  display: flex;
  gap: 10px;
  margin-bottom: 14px;
}

#saveBtn {
  flex: 1;
  background: #b33a2b;
  color: white;
  padding: 12px;
  border-radius: 14px;
  border: none;
  font-size: 16px;
  cursor: pointer;
}

/* ‰∏∏„ÅÑÊâãÊõ∏„Åç„Éú„Çø„É≥ */
#drawToggle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: #d96c5c;
  color: white;
  font-size: 20px;
  cursor: pointer;
}

/* ===== ÊâãÊõ∏„Åç ===== */
#canvasArea {
  display: none;
  margin-bottom: 16px;
}

#drawCanvas {
  width: 100%;
  height: 300px;
  border-radius: 16px;
  border: 1px solid #e0cfc2;
  background: white;
  touch-action: none;
}

#clearCanvas {
  margin-top: 8px;
  width: 100%;
  padding: 10px;
  border-radius: 14px;
  border: none;
  background: #999;
  color: white;
  font-size: 14px;
  cursor: pointer;
}

/* ===== „É°„É¢Ë°®Á§∫ ===== */
.memo {
  padding: 14px;
  border-radius: 18px;
  margin-bottom: 14px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}

.c0 { background:#fde2e2 }
.c1 { background:#f9e4c8 }
.c2 { background:#fcebd5 }
.c3 { background:#f6d6cc }
.c4 { background:#f3e7dc }

.memo-title {
  font-weight: bold;
  margin-bottom: 4px;
}

.memo-date {
  font-size: 12px;
  opacity: .6;
  margin-bottom: 6px;
}

.memo-text {
  white-space: pre-wrap;
  margin-bottom: 8px;
}

.memo-buttons {
  display: flex;
  gap: 8px;
}

.memo-buttons button {
  flex: 1;
  background: rgba(0,0,0,0.15);
  border: none;
  border-radius: 12px;
  padding: 8px;
  cursor: pointer;
}
</style>
</head>

<body>
<div class="app">
<h1>üêæ „Åí„Çä„É°„É¢</h1>

<input id="title" placeholder="„Çø„Ç§„Éà„É´">
<textarea id="memo" placeholder="„É°„É¢ÂÜÖÂÆπ"></textarea>

<div class="action-row">
  <button id="saveBtn">‰øùÂ≠ò</button>
  <button id="drawToggle" title="ÊâãÊõ∏„Åç„Åô„Çã">üêæ</button>
</div>

<div id="canvasArea">
  <canvas id="drawCanvas" width="400" height="300"></canvas>
  <button id="clearCanvas">„ÇØ„É™„Ç¢</button>
</div>

<div id="list"></div>
</div>

<script>
/* textarea Ëá™Âãï‰º∏Èï∑ */
const memoEl = document.getElementById('memo');
memoEl.addEventListener('input', () => {
  memoEl.style.height = 'auto';
  memoEl.style.height = memoEl.scrollHeight + 'px';
});

/* „Éá„Éº„Çø */
let memos = JSON.parse(localStorage.getItem('memos') || '[]');
let editIndex = null;

/* DOM */
const titleEl = document.getElementById('title');
const saveBtn = document.getElementById('saveBtn');
const drawToggle = document.getElementById('drawToggle');
const canvasArea = document.getElementById('canvasArea');
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');

/* ===== HTML„Ç®„Çπ„Ç±„Éº„ÉóÔºàËøΩÂä†„Éª‰øùÂ≠òÂΩ¢Âºè„ÅØÂ§â„Åà„Å™„ÅÑÔºâ ===== */
function escapeHTML(str){
  if(!str) return '';
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

/* ÊâãÊõ∏„Åç */
let drawing = false, lx = 0, ly = 0;

function pos(e){
  const r = canvas.getBoundingClientRect();
  const p = e.touches ? e.touches[0] : e;
  return {
    x:(p.clientX-r.left)*canvas.width/r.width,
    y:(p.clientY-r.top)*canvas.height/r.height
  };
}

canvas.onmousedown = e => { drawing = true; ({x:lx,y:ly}=pos(e)); };
canvas.onmousemove = e => {
  if(!drawing) return;
  const p = pos(e);
  ctx.beginPath();
  ctx.moveTo(lx,ly);
  ctx.lineTo(p.x,p.y);
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.stroke();
  lx = p.x; ly = p.y;
};
canvas.onmouseup = () => drawing = false;
canvas.ontouchstart = canvas.onmousedown;
canvas.ontouchmove = canvas.onmousemove;
canvas.ontouchend = () => drawing = false;

drawToggle.onclick = () => {
  canvasArea.style.display =
    canvasArea.style.display === 'none' ? 'block' : 'none';
};

clearCanvas.onclick = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
};

/* ‰øùÂ≠ò */
saveBtn.onclick = () => {
  if(!titleEl.value && !memoEl.value) return;

  const hasImg = ctx.getImageData(0,0,canvas.width,canvas.height)
    .data.some(v=>v!==0);

  const data = {
    title: titleEl.value,
    text: memoEl.value,
    img: hasImg ? canvas.toDataURL() : null,
    date: new Date().toLocaleString()
  };

  if(editIndex !== null){
    memos[editIndex] = data;
    editIndex = null;
  } else {
    memos.push(data);
  }

  localStorage.setItem('memos', JSON.stringify(memos));

  titleEl.value = '';
  memoEl.value = '';
  memoEl.style.height = 'auto';
  ctx.clearRect(0,0,canvas.width,canvas.height);
  canvasArea.style.display = 'none';

  render();
};

/* Ë°®Á§∫ */
function render(){
  list.innerHTML = '';
  memos.slice().reverse().forEach((m,i)=>{
    const idx = memos.length-1-i;
    const d = document.createElement('div');
    d.className = 'memo c'+(i%5);
    d.innerHTML = `
      <div class="memo-title">üêæ ${escapeHTML(m.title||'(ÁÑ°È°å)')}</div>
      <div class="memo-date">${m.date}</div>
      <div class="memo-text">${escapeHTML(m.text)}</div>
      ${m.img?`<img src="${m.img}" style="max-width:100%;border-radius:14px;">`:''}
      <div class="memo-buttons">
        <button>‚úèÔ∏è Á∑®ÈõÜ</button>
        <button>üóëÔ∏è ÂâäÈô§</button>
      </div>
    `;
    d.querySelectorAll('button')[0].onclick = () => {
      titleEl.value = m.title;
      memoEl.value = m.text;
      memoEl.dispatchEvent(new Event('input'));
      if(m.img){
        const img = new Image();
        img.onload = () => ctx.drawImage(img,0,0);
        img.src = m.img;
        canvasArea.style.display = 'block';
      }
      editIndex = idx;
      window.scrollTo({top:0,behavior:'smooth'});
    };
    d.querySelectorAll('button')[1].onclick = () => {
      memos.splice(idx,1);
      localStorage.setItem('memos',JSON.stringify(memos));
      render();
    };
    list.appendChild(d);
  });
}

render();
</script>
</body>
</html>
